<!DOCTYPE html>
<html>
<head>
    <title>Test Proxy</title>
</head>
<body>
    <h1>Test del Proxy API</h1>
    <button onclick="testHealth()">Test Health</button>
    <button onclick="testProducts()">Test Products</button>
    <button onclick="testFeatured()">Test Featured</button>
    <button onclick="testDirect()">Test Direct Backend</button>
    <button onclick="testProductBySku('ZP108W')">Test SKU ZP108W</button>
    <button onclick="testAllSkuVariants()">Test All SKU Variants</button>
    
    <div id="results"></div>

    <script>
        function log(message) {
            document.getElementById('results').innerHTML += '<p>' + message + '</p>';
        }

        async function testHealth() {
            log('Testing /api/health...');
            try {
                const response = await fetch('https://sillageperfum.cl/debug-proxy.php?path=api/health');
                const data = await response.json();
                log('Health Result: ' + JSON.stringify(data));
            } catch (error) {
                log('Health Error: ' + error.message);
            }
        }

        async function testProducts() {
            log('Testing /api/products...');
            try {
                const response = await fetch('https://sillageperfum.cl/debug-proxy.php?path=api/products&limit=5');
                const data = await response.json();
                log('Products Result: ' + JSON.stringify(data));
            } catch (error) {
                log('Products Error: ' + error.message);
            }
        }

        async function testFeatured() {
            log('Testing /api/products/featured...');
            try {
                const response = await fetch('https://sillageperfum.cl/debug-proxy.php?path=api/products/featured&limit=3');
                const data = await response.json();
                log('Featured Result: ' + JSON.stringify(data));
            } catch (error) {
                log('Featured Error: ' + error.message);
            }
        }

        async function testDirect() {
            log('Testing direct backend...');
            try {
                const response = await fetch('https://sillage-backend-m5hzs0ps5-sillageperfums-projects.vercel.app/api/health');
                const data = await response.json();
                log('Direct Backend Result: ' + JSON.stringify(data));
            } catch (error) {
                log('Direct Backend Error: ' + error.message);
            }
        }

        async function testProductBySku(baseSku) {
            log('\n=== Testing products with SKU base: ' + baseSku + ' ===');
            try {
                // Primero buscar todos los productos
                const response = await fetch('https://sillageperfum.cl/api-proxy.php?path=api/products&limit=200');
                const data = await response.json();
                
                if (data.products) {
                    // Filtrar productos que coincidan con el SKU base
                    const variants = data.products.filter(p => 
                        p.sku && p.sku.replace(/-\d+ML$/i, '') === baseSku
                    );
                    
                    log('Found ' + variants.length + ' variants for SKU base ' + baseSku);
                    
                    if (variants.length > 0) {
                        log('\nVariants found:');
                        variants.forEach(v => {
                            log('- SKU: ' + v.sku + ', Size: ' + v.size + ', Price: $' + v.price + ', Stock: ' + v.stock);
                        });
                    } else {
                        log('No variants found for this SKU base');
                    }
                }
            } catch (error) {
                log('SKU Search Error: ' + error.message);
            }
        }

        async function testAllSkuVariants() {
            log('\n=== Testing all products to find incomplete SKU sets ===');
            try {
                const response = await fetch('https://sillageperfum.cl/api-proxy.php?path=api/products&limit=500');
                const data = await response.json();
                
                if (data.products) {
                    // Agrupar productos por SKU base
                    const skuGroups = {};
                    
                    data.products.forEach(p => {
                        if (p.sku) {
                            const baseSku = p.sku.replace(/-\d+ML$/i, '');
                            if (!skuGroups[baseSku]) {
                                skuGroups[baseSku] = [];
                            }
                            skuGroups[baseSku].push(p);
                        }
                    });
                    
                    // Encontrar SKUs que no tienen las 3 variantes (30ml, 50ml, 100ml)
                    log('\nSKUs with incomplete size variants:');
                    let incompleteCount = 0;
                    
                    Object.keys(skuGroups).forEach(baseSku => {
                        const variants = skuGroups[baseSku];
                        const sizes = variants.map(v => v.size);
                        
                        if (sizes.length < 3 || !sizes.includes('30ml') || !sizes.includes('50ml') || !sizes.includes('100ml')) {
                            incompleteCount++;
                            log('\n' + baseSku + ' - Has ' + sizes.length + ' variant(s): ' + sizes.join(', '));
                            variants.forEach(v => {
                                log('  - ' + v.sku + ' (' + v.size + '): ' + v.name);
                            });
                        }
                    });
                    
                    log('\nTotal SKUs with incomplete variants: ' + incompleteCount);
                }
            } catch (error) {
                log('All SKU Variants Error: ' + error.message);
            }
        }
    </script>
</body>
</html>
